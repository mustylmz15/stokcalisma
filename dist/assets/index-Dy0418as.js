import{y as le,l as se,ad as ie,a5 as ue,r as y,t as de,ah as F,ai as ce,al as ve,m as P,c as p,a as t,V as M,O as g,S as h,M as D,N as O,e as pe,a7 as L,b as ke,U as q,d as I,o as k}from"./index-CMVsiJL9.js";const ge={class:"grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6"},me={class:"panel"},ye={class:"flex flex-wrap justify-between mb-5"},fe={class:"font-semibold text-lg dark:text-white-light"},be={class:"mb-5 grid grid-cols-1 sm:grid-cols-4 gap-4"},he=["value"],we=["value"],Se=["value"],De={key:0},Ie={class:"table-responsive"},je={class:"table-striped"},xe={key:0},Le={key:0},Te=["colspan"],Pe={key:1},Me={key:2},qe={key:3},Ae={key:0},Ne={class:"flex items-center justify-between mt-5"},Ke={class:"flex items-center gap-2"},We={class:"flex items-center gap-2"},Ce=["disabled"],Re=["disabled"],Be=le({__name:"index",setup($e){const w=se(),m=ie(),$=ue(),T=y(!1),d=y("stock-status"),A=y([]),N=y([]),K=y([]),f=y([]),H=y([]),j=y(10),S=y(1),b=y(null),u=y({startDate:"",endDate:"",categoryId:"",warehouseId:"",movementType:"",stockStatus:"",projectId:""});de(()=>{b.value=$.activeProjectId;const a=e=>{console.log("Rapor sayfası: Proje değişikliği algılandı:",e),b.value=e,W()};F.on("project-changed",a),ce(()=>{F.off("project-changed",a)}),J()}),ve([d,u,S,j],()=>{d.value!=="movement-history"&&(S.value=1),W()});const J=async()=>{f.value=m.getWarehouses,H.value=m.getCategories,W()},W=async()=>{T.value=!0;try{switch(d.value){case"stock-status":_();break;case"movement-history":ee();break;case"low-stock":te();break}}catch(a){console.error("Rapor yüklenirken hata oluştu:",a)}finally{T.value=!1}},Q=a=>{var e;return(e=a.product)!=null&&e.minStockLevel?a.quantity>a.product.minStockLevel:!1},X=a=>{var e;return(e=a.product)!=null&&e.minStockLevel?a.quantity===a.product.minStockLevel:!1},Z=a=>{var e;return(e=a.product)!=null&&e.minStockLevel?a.quantity<a.product.minStockLevel:!1},_=()=>{try{console.log("Stok durum raporu yükleniyor...");const a=m.getStocks||[],e=m.getProducts||[];console.log(`${a.length} stok kaydı, ${e.length} ürün bulundu`);const r=[];for(const s of a){const o=e.find(i=>i.id===s.productId),n=f.value.find(i=>i.id===s.warehouseId);if(o&&n){const i=o.category||{id:"",name:"Kategori Yok",description:""};r.push({id:s.id,product:{id:o.id,code:o.code||"",name:o.name||"",unit:o.unit||"",categoryId:o.categoryId||"",minStockLevel:o.minStockLevel||0,isActive:!!o.isActive,category:i,description:o.description},warehouse:{id:n.id,code:n.code||"",name:n.name||""},quantity:s.quantity||0})}}console.log(`${r.length} geçerli stok kaydı işlendi`);let l=[...r];if(!w.isAdmin){const s=w.getAuthorizedDepot;if(s){const o=f.value.find(n=>n.code===s);o&&(l=l.filter(n=>{var i;return((i=n.warehouse)==null?void 0:i.id)===o.id}))}}if(u.value.warehouseId&&(l=l.filter(s=>{var o;return((o=s.warehouse)==null?void 0:o.id)===u.value.warehouseId})),u.value.categoryId&&(l=l.filter(s=>{var o,n;return((n=(o=s.product)==null?void 0:o.category)==null?void 0:n.id)===u.value.categoryId})),u.value.projectId?l=l.filter(s=>"projectId"in s&&s.projectId===u.value.projectId?!0:m.getStocksByProject(u.value.projectId).some(o=>o.id===s.id)):b.value!==null&&(l=l.filter(s=>"projectId"in s&&s.projectId===b.value?!0:m.getStocksByProject(b.value).some(o=>o.id===s.id))),u.value.stockStatus){const s=u.value.stockStatus;s==="low"?l=l.filter(o=>{var n;return o.quantity<(((n=o.product)==null?void 0:n.minStockLevel)||0)}):s==="critical"?l=l.filter(o=>{var n;return o.quantity===(((n=o.product)==null?void 0:n.minStockLevel)||0)}):s==="normal"&&(l=l.filter(o=>{var n;return o.quantity>(((n=o.product)==null?void 0:n.minStockLevel)||0)}))}A.value=l,console.log(`${l.length} kayıt filtrelendi ve gösteriliyor`)}catch(a){console.error("Stok verilerini yüklerken hata:",a),A.value=[]}},ee=()=>{try{console.log("Hareket geçmişi verisi yükleniyor");const a=m.getMovements||[],e=m.getProducts||[];console.log(`${a.length} hareket kaydı bulundu`);const r=[];for(const o of a)try{const n=e.find(v=>v.id===o.productId),i=f.value.find(v=>v.id===o.sourceWarehouseId),c=o.targetWarehouseId?f.value.find(v=>v.id===o.targetWarehouseId):void 0;n&&i?r.push({id:o.id,date:typeof o.date=="string"?o.date:new Date().toISOString(),movementNumber:o.movementNumber||`HRK-${o.id.slice(0,8)}`,type:o.type,product:{id:n.id,code:n.code||"Kod Yok",name:n.name||"İsimsiz Ürün",unit:n.unit||"",minStockLevel:n.minStockLevel||0,categoryId:n.categoryId||"",isActive:!!n.isActive,category:n.category||{id:"",name:"Kategori Yok",description:""}},quantity:o.quantity||0,sourceWarehouse:{id:i.id,code:i.code||"",name:i.name||"İsimsiz Depo"},targetWarehouse:c?{id:c.id,code:c.code||"",name:c.name||"İsimsiz Depo"}:void 0,description:o.description||""}):console.warn("Eksik hareket bileşenleri:",{movementId:o.id,productFound:!!n,sourceWarehouseFound:!!i})}catch(n){console.error("Hareket dönüştürmede hata:",n)}console.log(`${r.length} hareket kaydı işlendi`);let l=[...r];const s=w.isAdmin?null:w.getAuthorizedDepot;if(s){const o=f.value.find(n=>n.code===String(s));o&&(l=l.filter(n=>{var i,c;return((i=n.sourceWarehouse)==null?void 0:i.id)===o.id||((c=n.targetWarehouse)==null?void 0:c.id)===o.id}))}if(u.value.startDate&&u.value.endDate){const o=new Date(u.value.startDate),n=new Date(u.value.endDate);n.setHours(23,59,59,999),l=l.filter(i=>{try{const c=new Date(i.date);return!isNaN(c.getTime())&&c>=o&&c<=n}catch{return!1}})}u.value.warehouseId&&(l=l.filter(o=>{var n,i;return((n=o.sourceWarehouse)==null?void 0:n.id)===u.value.warehouseId||((i=o.targetWarehouse)==null?void 0:i.id)===u.value.warehouseId})),u.value.movementType&&(l=l.filter(o=>o.type===u.value.movementType)),u.value.projectId?l=l.filter(o=>"sourceProjectId"in o&&o.sourceProjectId===u.value.projectId||"targetProjectId"in o&&o.targetProjectId===u.value.projectId?!0:m.getMovementsByProject(u.value.projectId).some(i=>i.id===o.id)):b.value!==null&&(l=l.filter(o=>"sourceProjectId"in o&&o.sourceProjectId===b.value||"targetProjectId"in o&&o.targetProjectId===b.value?!0:m.getMovementsByProject(b.value).some(i=>i.id===o.id))),l.sort((o,n)=>new Date(n.date).getTime()-new Date(o.date).getTime()),N.value=l,console.log(`${l.length} hareket kaydı filtrelendi ve gösteriliyor`)}catch(a){console.error("Hareket geçmişi yüklenirken hata:",a),N.value=[]}},te=()=>{try{console.log("Kritik stok verileri yükleniyor");const a=m.getStocks||[],e=m.getProducts||[],r=[];for(const o of a){const n=e.find(c=>c.id===o.productId),i=f.value.find(c=>c.id===o.warehouseId);if(n&&i){const c=n.category||{id:"",name:"Kategori Yok",description:""};r.push({id:o.id,product:{id:n.id,code:n.code||"",name:n.name||"",unit:n.unit||"",categoryId:n.categoryId||"",minStockLevel:n.minStockLevel||0,isActive:!!n.isActive,category:c,description:n.description},warehouse:{id:i.id,code:i.code||"",name:i.name||""},quantity:o.quantity||0})}}const l=r.filter(o=>{var n;return o.quantity<=(((n=o.product)==null?void 0:n.minStockLevel)||0)});console.log(`${l.length} kritik stok seviyesinde ürün bulundu`);let s=[...l];if(!w.isAdmin){const o=w.getAuthorizedDepot;if(o){const n=f.value.find(i=>i.code===o);n&&(s=s.filter(i=>{var c;return((c=i.warehouse)==null?void 0:c.id)===n.id}))}}u.value.warehouseId&&(s=s.filter(o=>{var n;return((n=o.warehouse)==null?void 0:n.id)===u.value.warehouseId})),u.value.categoryId&&(s=s.filter(o=>{var n,i;return((i=(n=o.product)==null?void 0:n.category)==null?void 0:i.id)===u.value.categoryId})),K.value=s,console.log(`${s.length} kritik stok kaydı filtrelendi ve gösteriliyor`)}catch(a){console.error("Kritik stok verilerini yüklerken hata:",a),K.value=[]}},oe=P(()=>{if(w.isAdmin)return f.value;const a=w.getAuthorizedDepot;return a?f.value.filter(e=>e.code===String(a)):[]}),re=P(()=>$.userProjects||[]),C=a=>{d.value=a,W()},B=a=>{if(!a)return"-";try{const e=new Date(a);return isNaN(e.getTime())?"-":e.toLocaleString("tr-TR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch(e){return console.error("Tarih formatlama hatası:",e),"-"}},V=a=>{switch(a){case"in":return"Giriş";case"out":return"Çıkış";case"transfer":return"Transfer";case"stock_add":return"Stok Ekleme";default:return a}},U=a=>{var e;return(e=a==null?void 0:a.product)!=null&&e.minStockLevel?a.quantity>a.product.minStockLevel?"Normal":a.quantity===a.product.minStockLevel?"Kritik":"Düşük":"-"},ne=async()=>{try{T.value=!0;const a=R.value,e=d.value==="stock-status"?"Stok_Durum":d.value==="movement-history"?"Hareket_Gecmisi":"Kritik_Stok",r=new Date().toLocaleDateString("tr-TR").replace(/\./g,"-"),l=`${e}_${r}.csv`;let s="",o=[];d.value==="movement-history"?(s="Hareket No,Tarih,Hareket Tipi,Ürün,Miktar,Kaynak Depo,Hedef Depo,Açıklama",o=a.map(v=>{var Y;return[v.movementNumber,B(v.date),V(v.type),v.product.name,v.quantity.toString(),v.sourceWarehouse.name,v.type==="transfer"&&((Y=v.targetWarehouse)==null?void 0:Y.name)||"-",v.description||"-"].join(",")})):(s="Ürün Kodu,Ürün Adı,Kategori,Depo,Miktar,Min. Stok,Durum"+(d.value==="low-stock"?",Eksik Miktar":""),o=a.map(v=>[v.product.code,v.product.name,v.product.category.name,v.warehouse.name,v.quantity.toString(),v.product.minStockLevel.toString(),U(v),d.value==="low-stock"?(v.product.minStockLevel-v.quantity).toString():""].filter(Boolean).join(",")));const n=[s,...o].join(`
`),i=new Blob([n],{type:"text/csv;charset=utf-8;"}),c=document.createElement("a");c.href=URL.createObjectURL(i),c.setAttribute("download",l),document.body.appendChild(c),c.click(),document.body.removeChild(c)}catch(a){console.error("Rapor dışa aktarılırken hata oluştu:",a)}finally{T.value=!1}},R=P(()=>{switch(d.value){case"stock-status":return A.value;case"movement-history":return N.value;case"low-stock":return K.value;default:return[]}}),z=P(()=>Math.max(1,Math.ceil(R.value.length/j.value))),E=P(()=>{const a=(S.value-1)*j.value,e=a+j.value;return R.value.slice(a,e)}),G=a=>a&&a.warehouse!==void 0&&a.product!==void 0,x=a=>a&&a.movementNumber!==void 0&&a.sourceWarehouse!==void 0,ae=a=>{if(G(a))return a.warehouse};return(a,e)=>(k(),p("div",null,[t("div",ge,[t("div",{class:M(["panel cursor-pointer transition-all duration-300 hover:shadow-[0_0_15px_1px_rgba(0,0,0,0.15)] bg-success/10 dark:bg-success/20 hover:bg-success/20 dark:hover:bg-success/30",{"ring-2 ring-success":d.value==="stock-status"}]),onClick:e[0]||(e[0]=r=>C("stock-status"))},e[13]||(e[13]=[t("div",{class:"flex items-start"},[t("div",{class:"flex-1"},[t("h5",{class:"font-semibold text-lg mb-2"},"Stok Durum Raporu"),t("p",{class:"text-[13px] text-white-dark"},"Tüm ürünlerin güncel stok durumunu görüntüleyin")])],-1)]),2),t("div",{class:M(["panel cursor-pointer transition-all duration-300 hover:shadow-[0_0_15px_1px_rgba(0,0,0,0.15)] bg-info/10 dark:bg-info/20 hover:bg-info/20 dark:hover:bg-info/30",{"ring-2 ring-info":d.value==="movement-history"}]),onClick:e[1]||(e[1]=r=>C("movement-history"))},e[14]||(e[14]=[t("div",{class:"flex items-start"},[t("div",{class:"flex-1"},[t("h5",{class:"font-semibold text-lg mb-2"},"Hareket Geçmişi"),t("p",{class:"text-[13px] text-white-dark"},"Stok hareketlerini analiz edin")])],-1)]),2),t("div",{class:M(["panel cursor-pointer transition-all duration-300 hover:shadow-[0_0_15px_1px_rgba(0,0,0,0.15)] bg-warning/10 dark:bg-warning/20 hover:bg-warning/20 dark:hover:bg-warning/30",{"ring-2 ring-warning":d.value==="low-stock"}]),onClick:e[2]||(e[2]=r=>C("low-stock"))},e[15]||(e[15]=[t("div",{class:"flex items-start"},[t("div",{class:"flex-1"},[t("h5",{class:"font-semibold text-lg mb-2"},"Kritik Stok Raporu"),t("p",{class:"text-[13px] text-white-dark"},"Minimum stok seviyesinin altındaki ürünleri listeleyin")])],-1)]),2)]),t("div",me,[t("div",ye,[t("h5",fe,g(d.value==="stock-status"?"Stok Durum Raporu":d.value==="movement-history"?"Hareket Geçmişi":d.value==="low-stock"?"Kritik Stok Raporu":""),1),t("button",{class:"btn btn-primary",onClick:ne}," Dışa Aktar ")]),t("div",be,[d.value==="movement-history"?(k(),p(h,{key:0},[t("div",null,[e[16]||(e[16]=t("label",null,"Başlangıç Tarihi",-1)),D(t("input",{type:"date",class:"form-input","onUpdate:modelValue":e[3]||(e[3]=r=>u.value.startDate=r)},null,512),[[O,u.value.startDate]])]),t("div",null,[e[17]||(e[17]=t("label",null,"Bitiş Tarihi",-1)),D(t("input",{type:"date",class:"form-input","onUpdate:modelValue":e[4]||(e[4]=r=>u.value.endDate=r)},null,512),[[O,u.value.endDate]])]),t("div",null,[e[19]||(e[19]=t("label",null,"Hareket Tipi",-1)),e[20]||(e[20]=pe()),D(t("select",{class:"form-select","onUpdate:modelValue":e[5]||(e[5]=r=>u.value.movementType=r)},e[18]||(e[18]=[ke('<option value="">Tümü</option><option value="in">Giriş</option><option value="out">Çıkış</option><option value="transfer">Transfer</option><option value="stock_add">Stok Ekleme</option>',5)]),512),[[L,u.value.movementType]])])],64)):(k(),p(h,{key:1},[t("div",null,[e[22]||(e[22]=t("label",null,"Proje",-1)),D(t("select",{class:"form-select","onUpdate:modelValue":e[6]||(e[6]=r=>u.value.projectId=r)},[e[21]||(e[21]=t("option",{value:""},"Tümü",-1)),(k(!0),p(h,null,q(re.value,r=>(k(),p("option",{key:r.id,value:r.id},g(r.name),9,he))),128))],512),[[L,u.value.projectId]])]),t("div",null,[e[24]||(e[24]=t("label",null,"Kategori",-1)),D(t("select",{class:"form-select","onUpdate:modelValue":e[7]||(e[7]=r=>u.value.categoryId=r)},[e[23]||(e[23]=t("option",{value:""},"Tümü",-1)),(k(!0),p(h,null,q(H.value,r=>(k(),p("option",{key:r.id,value:r.id},g(r.name),9,we))),128))],512),[[L,u.value.categoryId]])]),t("div",null,[e[26]||(e[26]=t("label",null,"Depo",-1)),D(t("select",{class:"form-select","onUpdate:modelValue":e[8]||(e[8]=r=>u.value.warehouseId=r)},[e[25]||(e[25]=t("option",{value:""},"Tümü",-1)),(k(!0),p(h,null,q(oe.value,r=>(k(),p("option",{key:r.id,value:r.id},g(r.name),9,Se))),128))],512),[[L,u.value.warehouseId]])]),d.value==="stock-status"?(k(),p("div",De,[e[28]||(e[28]=t("label",null,"Stok Durumu",-1)),D(t("select",{class:"form-select","onUpdate:modelValue":e[9]||(e[9]=r=>u.value.stockStatus=r)},e[27]||(e[27]=[t("option",{value:""},"Tümü",-1),t("option",{value:"normal"},"Normal",-1),t("option",{value:"critical"},"Kritik",-1),t("option",{value:"low"},"Düşük",-1)]),512),[[L,u.value.stockStatus]])])):I("",!0)],64))]),t("div",Ie,[t("table",je,[t("thead",null,[t("tr",null,[d.value==="stock-status"||d.value==="low-stock"?(k(),p(h,{key:0},[e[29]||(e[29]=t("th",null,"Ürün Kodu",-1)),e[30]||(e[30]=t("th",null,"Ürün Adı",-1)),e[31]||(e[31]=t("th",null,"Kategori",-1)),e[32]||(e[32]=t("th",null,"Depo",-1)),e[33]||(e[33]=t("th",null,"Miktar",-1)),e[34]||(e[34]=t("th",null,"Min. Stok",-1)),d.value==="low-stock"?(k(),p("th",xe,"Eksik Miktar")):I("",!0),e[35]||(e[35]=t("th",null,"Durum",-1))],64)):d.value==="movement-history"?(k(),p(h,{key:1},[e[36]||(e[36]=t("th",null,"Hareket No",-1)),e[37]||(e[37]=t("th",null,"Tarih",-1)),e[38]||(e[38]=t("th",null,"Hareket Tipi",-1)),e[39]||(e[39]=t("th",null,"Ürün",-1)),e[40]||(e[40]=t("th",null,"Miktar",-1)),e[41]||(e[41]=t("th",null,"Kaynak Depo",-1)),e[42]||(e[42]=t("th",null,"Hedef Depo",-1)),e[43]||(e[43]=t("th",null,"Açıklama",-1))],64)):I("",!0)])]),t("tbody",null,[T.value?(k(),p("tr",Le,[t("td",{colspan:d.value==="movement-history"?8:7,class:"text-center"},e[44]||(e[44]=[t("div",{class:"flex justify-center items-center p-4"},[t("div",{class:"animate-spin rounded-full h-6 w-6 border-2 border-primary border-l-transparent"})],-1)]),8,Te)])):d.value==="stock-status"&&A.value.length===0?(k(),p("tr",Pe,e[45]||(e[45]=[t("td",{colspan:"7",class:"text-center"},"Stok verisi bulunamadı.",-1)]))):d.value==="movement-history"&&N.value.length===0?(k(),p("tr",Me,e[46]||(e[46]=[t("td",{colspan:"8",class:"text-center"},"Hareket verisi bulunamadı.",-1)]))):d.value==="low-stock"&&K.value.length===0?(k(),p("tr",qe,e[47]||(e[47]=[t("td",{colspan:"8",class:"text-center"},"Kritik stok seviyesinde ürün bulunmamaktadır.",-1)]))):I("",!0),d.value==="stock-status"||d.value==="low-stock"?(k(!0),p(h,{key:4},q(E.value,r=>{var l,s,o,n,i,c,v;return k(),p("tr",{key:r.id},[t("td",null,g(((l=r.product)==null?void 0:l.code)||"-"),1),t("td",null,g(((s=r.product)==null?void 0:s.name)||"-"),1),t("td",null,g(((n=(o=r.product)==null?void 0:o.category)==null?void 0:n.name)||"-"),1),t("td",null,g(((i=ae(r))==null?void 0:i.name)||"-"),1),t("td",null,g(r.quantity),1),t("td",null,g(((c=r.product)==null?void 0:c.minStockLevel)||0),1),d.value==="low-stock"?(k(),p("td",Ae,g((((v=r.product)==null?void 0:v.minStockLevel)||0)-r.quantity),1)):I("",!0),t("td",null,[t("span",{class:M({"badge badge-success":Q(r),"badge badge-warning":X(r),"badge badge-danger":Z(r)})},g(U(G(r)?r:void 0)),3)])])}),128)):I("",!0),d.value==="movement-history"?(k(!0),p(h,{key:5},q(E.value,r=>{var l,s,o;return k(),p("tr",{key:r.id},[t("td",null,g(x(r)?r.movementNumber:"-"),1),t("td",null,g(x(r)?B(r.date):"-"),1),t("td",null,[x(r)?(k(),p("span",{key:0,class:M({"badge badge-success":r.type==="in","badge badge-danger":r.type==="out","badge badge-info":r.type==="transfer","badge badge-warning":r.type==="stock_add"})},g(V(r.type)),3)):I("",!0)]),t("td",null,g(((l=r.product)==null?void 0:l.name)||"-"),1),t("td",null,g(r.quantity),1),t("td",null,g(x(r)?(s=r.sourceWarehouse)==null?void 0:s.name:"-"),1),t("td",null,g(x(r)&&(r.type==="transfer"||r.type==="stock_add")?(o=r.targetWarehouse)==null?void 0:o.name:"-"),1),t("td",null,g(x(r)?r.description:"-"),1)])}),128)):I("",!0)])])]),t("div",Ne,[t("div",Ke,[D(t("select",{class:"form-select w-20","onUpdate:modelValue":e[10]||(e[10]=r=>j.value=r)},e[48]||(e[48]=[t("option",null,"10",-1),t("option",null,"20",-1),t("option",null,"50",-1),t("option",null,"100",-1)]),512),[[L,j.value]]),e[49]||(e[49]=t("span",null,"kayıt gösteriliyor",-1))]),t("div",We,[t("button",{class:"btn btn-outline-primary p-2",disabled:S.value===1,onClick:e[11]||(e[11]=r=>S.value--)}," ← ",8,Ce),t("span",null,"Sayfa "+g(S.value)+" / "+g(z.value),1),t("button",{class:"btn btn-outline-primary p-2",disabled:S.value===z.value,onClick:e[12]||(e[12]=r=>S.value++)}," → ",8,Re)])])])]))}});export{Be as default};
