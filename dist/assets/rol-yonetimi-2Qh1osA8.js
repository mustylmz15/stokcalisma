const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CMVsiJL9.js","assets/index-FewHoYh-.css"])))=>i.map(i=>d[i]);
import{y as de,l as pe,a5 as me,G as ye,m as G,r as P,F as J,t as ge,c as g,a as e,d as k,e as A,V as he,O as w,S as L,U as q,a6 as be,M as H,a7 as ve,a8 as fe,a9 as v,o as m,aa as W,a3 as je,ab as _e}from"./index-CMVsiJL9.js";const ke={class:"panel"},we={class:"flex mb-5 justify-between"},Re={class:"flex items-center"},Pe={key:0,class:"animate-spin border-2 border-primary border-l-transparent rounded-full w-5 h-5 inline-block align-middle"},De={class:"mb-5"},Ee={class:"mb-5"},$e={key:0,class:"animate-spin border-2 border-white border-l-transparent rounded-full w-4 h-4 inline-block align-middle mr-2"},xe={key:0},Ie={key:0,class:"table-responsive"},Ae={class:"table-striped"},Se={class:"flex flex-wrap gap-1"},Te={key:0,class:"badge badge-outline-primary"},Ve=["onClick"],ze={key:1,class:"flex justify-center items-center p-5"},Fe={key:2,class:"flex justify-center items-center p-5"},Me={key:0,class:"fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center"},Ue={class:"panel max-w-lg w-full"},Ke={class:"flex justify-between items-center mb-5"},Ce={class:"font-semibold text-lg"},Oe={key:0},Le={class:"mb-5"},qe={class:"mb-5"},Be={key:0},Ne={class:"flex justify-between items-center mb-2"},Qe={class:"font-semibold"},Ye={class:"flex flex-wrap gap-2"},Ge=["value","onUpdate:modelValue","name"],He={class:"text-sm ml-2"},Je={class:"flex items-center"},We=["onUpdate:modelValue","name"],Xe={key:1,class:"text-center p-3 text-gray-500"},Ze={class:"flex justify-end gap-2 mt-5"},eo=["disabled"],oo={key:0,class:"animate-spin border-2 border-white border-l-transparent rounded-full w-4 h-4 inline-block align-middle mr-2"},so=de({__name:"rol-yonetimi",setup(lo){const S=pe(),D=me(),E=ye(),T=G(()=>{try{return je()}catch(o){return console.warn("Rol servisi erişilemedi:",o),null}});G(()=>{try{if(T.value)return T.value.isAdmin()}catch(o){console.warn("Rol servisi ile admin kontrolü yapılamadı:",o)}return S.isAdmin});const X=G(()=>{try{if(T.value)return T.value.hasPermission(_e.EDIT_USERS)||T.value.isAdmin()}catch(o){console.warn("Rol servisi ile izin kontrolü yapılamadı:",o)}return S.isAdmin}),V=P([]),$=P([]),M=P(!1),U=P(!1),B=P(!1),f=P(null),N=P(!1),_=P(null),z=J({globalRole:""}),j=J({}),Z=P([{value:"proje_admin",label:"Proje Admin"},{value:"depo_sorumlusu",label:"Depo Sorumlusu"},{value:"user",label:"Kullanıcı"}]);async function K(){try{M.value=!0,console.log("Kullanıcılar yükleniyor...");const o=await S.getAllUsers();if(console.log(`Firebase'den ${o.length} kullanıcı çekildi.`),console.log("Kullanıcı Rolleri Detayı:"),o.forEach(l=>{console.log(`${l.email} => Rol: ${l.role}`)}),o&&Array.isArray(o)&&o.length>0){const{collection:l,getDocs:t}=await v(async()=>{const{collection:a,getDocs:i}=await import("./index-CMVsiJL9.js").then(p=>p.aP);return{collection:a,getDocs:i}},__vite__mapDeps([0,1])),{db:u}=await v(async()=>{const{db:a}=await import("./index-CMVsiJL9.js").then(i=>i.aQ);return{db:a}},__vite__mapDeps([0,1])),h=l(u,"userProjects"),b=await t(h),y=new Map;b.forEach(a=>{const i=a.data(),p=i.userId,s=i.projectId,r=i.role;y.has(p)||y.set(p,[]),y.get(p).push({projectId:s,role:r})});for(let a of o)if(a.id)try{const i=[],p=y.get(a.id)||[];if(p.length>0)for(let s of p)try{const r=s.projectId,d=s.role,c=D.projects.find(n=>n.id===r);if(c)i.push({projectId:r,projectName:c.name,role:d});else{console.log(`Proje ${r} bulunamadı, direk isim çekiliyor...`);try{const{doc:n,getDoc:R}=await v(async()=>{const{doc:F,getDoc:Y}=await import("./index-CMVsiJL9.js").then(C=>C.aP);return{doc:F,getDoc:Y}},__vite__mapDeps([0,1])),x=n(u,"projects",r),I=await R(x);if(I.exists()){const F=I.data();i.push({projectId:r,projectName:F.name||"İsimsiz Proje",role:d})}}catch(n){console.error(`Proje ${r} adı alınamadı:`,n),i.push({projectId:r,projectName:`Proje ID: ${r}`,role:d})}}}catch(r){console.error(`Proje bilgisi alınamadı (${s.projectId}):`,r)}a.projectRoles=i}catch(i){console.error(`Kullanıcı ${a.id} için proje rolleri alınamadı:`,i),a.projectRoles=[]}V.value=o,console.log("Kullanıcılar başarıyla yüklendi:",V.value.length)}else console.warn("Firebase'den kullanıcı listesi alınamadı veya boş."),V.value=[]}catch(o){console.error("Kullanıcılar yüklenirken hata:",o),E.showMessage?E.showMessage("Kullanıcılar yüklenirken hata oluştu","error"):alert("Kullanıcılar yüklenirken hata oluştu")}finally{M.value=!1}}async function ee(){try{if(console.log("Projeler yükleniyor..."),D.isInitialized?console.log("Project store zaten initialize edilmiş."):(console.log("Project store initialize ediliyor..."),await D.initializeStore()),D.projects&&Array.isArray(D.projects))console.log(`${D.projects.length} proje bulundu.`),$.value=D.projects;else{console.warn("Proje listesi bulunamadı veya dizi değil");try{const{collection:o,getDocs:l}=await v(async()=>{const{collection:y,getDocs:a}=await import("./index-CMVsiJL9.js").then(i=>i.aP);return{collection:y,getDocs:a}},__vite__mapDeps([0,1])),{db:t}=await v(async()=>{const{db:y}=await import("./index-CMVsiJL9.js").then(a=>a.aQ);return{db:y}},__vite__mapDeps([0,1]));console.log("Firebase'den projeler direkt çekiliyor...");const u=o(t,"projects"),h=await l(u),b=[];h.forEach(y=>{const a=y.data();b.push({id:y.id,name:a.name||"İsimsiz Proje",description:a.description})}),console.log(`Firebase'den ${b.length} proje çekildi.`),$.value=b}catch(o){console.error("Firebase'den projeler çekilirken hata:",o),$.value=[]}}}catch(o){console.error("Projeler yüklenirken hata:",o),E.showMessage?E.showMessage("Projeler yüklenirken hata oluştu","error"):alert("Projeler yüklenirken hata oluştu")}}async function oe(o){try{const{collection:l,query:t,where:u,getDocs:h}=await v(async()=>{const{collection:s,query:r,where:d,getDocs:c}=await import("./index-CMVsiJL9.js").then(n=>n.aP);return{collection:s,query:r,where:d,getDocs:c}},__vite__mapDeps([0,1])),{db:b}=await v(async()=>{const{db:s}=await import("./index-CMVsiJL9.js").then(r=>r.aQ);return{db:s}},__vite__mapDeps([0,1]));console.log(`Firebase'den ${o} kullanıcısı için projeler çekiliyor...`);const y=l(b,"userProjects"),a=t(y,u("userId","==",o)),i=await h(a),p=[];return i.forEach(s=>{const r=s.data();r.projectId&&p.push(r.projectId)}),console.log(`${p.length} proje bulundu kullanıcı için (${o}).`),p}catch(l){return console.error(`${o} kullanıcısı için projeler alınırken hata:`,l),[]}}async function le(){try{N.value=!0,_.value=null;const{collection:o,getDocs:l,doc:t,updateDoc:u}=await v(async()=>{const{collection:p,getDocs:s,doc:r,updateDoc:d}=await import("./index-CMVsiJL9.js").then(c=>c.aP);return{collection:p,getDocs:s,doc:r,updateDoc:d}},__vite__mapDeps([0,1])),{db:h}=await v(async()=>{const{db:p}=await import("./index-CMVsiJL9.js").then(s=>s.aQ);return{db:p}},__vite__mapDeps([0,1]));console.log("Firebase kullanıcı rollerini düzeltme işlemi başlatılıyor...");const b=await l(o(h,"users"));let y=0,a=0;const i=[];for(const p of b.docs)try{const s=p.data();if(console.log(`İşleniyor: ${s.email} (Mevcut rol: ${s.role||"Rol Yok"})`),!s.role||s.role!=="admin"&&s.role!=="user"&&s.role!=="proje_admin"&&s.role!=="depo_sorumlusu"){const r=await oe(p.id);let d="user";if(s.email&&(s.email.includes("admin")||s.email==="deneme@deneme.com"))d="admin";else if(r.length>0)for(const c of r)try{const{collection:n,query:R,where:x,getDocs:I}=await v(async()=>{const{collection:O,query:ae,where:ie,getDocs:ce}=await import("./index-CMVsiJL9.js").then(ue=>ue.aP);return{collection:O,query:ae,where:ie,getDocs:ce}},__vite__mapDeps([0,1])),F=n(h,"userProjects"),Y=R(F,x("userId","==",p.id),x("projectId","==",c)),C=await I(Y);if(!C.empty){const O=C.docs[0].data();if(O.role==="proje_admin"){d="proje_admin";break}else O.role==="depo_sorumlusu"&&d==="user"&&(d="depo_sorumlusu")}}catch(n){console.error(`Proje ${c} için rol kontrolü yapılırken hata:`,n)}await u(t(h,"users",p.id),{role:d}),console.log(`${s.email} kullanıcısının rolü '${d}' olarak güncellendi.`),i.push(`${s.email}: ${s.role||"Rol Yok"} → ${d}`),y++}}catch(s){console.error("Kullanıcı işlenirken hata:",s),a++}y>0?_.value={success:!0,message:`${y} kullanıcının rolü başarıyla güncellendi.`,details:i.join(", ")}:_.value={success:!0,message:"Güncellenmesi gereken kullanıcı bulunamadı. Tüm roller doğru."},await K()}catch(o){console.error("Firebase rolleri düzeltilirken hata:",o),_.value={success:!1,message:`Hata oluştu: ${o.message||"Bilinmeyen hata"}`}}finally{N.value=!1}}async function te(){try{console.log("Firebase kullanıcı verilerini inceleme başlatılıyor...");const{collection:o,getDocs:l,query:t,where:u}=await v(async()=>{const{collection:c,getDocs:n,query:R,where:x}=await import("./index-CMVsiJL9.js").then(I=>I.aP);return{collection:c,getDocs:n,query:R,where:x}},__vite__mapDeps([0,1])),{db:h}=await v(async()=>{const{db:c}=await import("./index-CMVsiJL9.js").then(n=>n.aQ);return{db:c}},__vite__mapDeps([0,1])),b=o(h,"users"),y=await l(b);console.log(`Toplam ${y.size} kullanıcı bulundu.`);const a={},i=[];y.forEach(c=>{const n=c.data(),R=n.role;R?a[R]=(a[R]||0)+1:i.push(`${n.email||"Email Yok"} (${c.id})`)}),console.log("Rol Dağılımı:");for(const[c,n]of Object.entries(a))console.log(`${c}: ${n} kullanıcı`);i.length>0?(console.log(`Rolü olmayan ${i.length} kullanıcı bulundu:`),console.log(i)):console.log("Tüm kullanıcılarda rol tanımlanmış.");const p=o(h,"userProjects"),s=await l(p);console.log(`Toplam ${s.size} kullanıcı-proje ilişkisi bulundu.`);const r={},d=[];for(const c of s.docs){const n=c.data();n.role?r[n.role]=(r[n.role]||0)+1:d.push(`${n.userId} - ${n.projectId}`)}console.log("Proje Rol Dağılımı:");for(const[c,n]of Object.entries(r))console.log(`${c}: ${n} ilişki`);return d.length>0?(console.log(`Rolü olmayan ${d.length} kullanıcı-proje ilişkisi bulundu:`),console.log(d)):console.log("Tüm kullanıcı-proje ilişkilerinde rol tanımlanmış."),{success:!0,userCount:y.size,roleCounts:a,missingRoleUsers:i.length,userProjectRelations:s.size,projectRoleCounts:r}}catch(o){return console.error("Firebase kullanıcı verilerini incelerken hata:",o),{success:!1,error:o instanceof Error?o.message:"Bilinmeyen hata"}}}async function se(o){f.value=o,z.globalRole=o.role||"";for(let t in j)delete j[t];if(console.log("Kullanıcı seçildi:",o.name),console.log("Kullanıcı projeleri:",o.projectRoles?o.projectRoles.length:0),($.value||[]).forEach(t=>{j[t.id]=""}),o.projectRoles&&o.projectRoles.length>0)for(let t of o.projectRoles)j[t.projectId]=t.role;try{const{collection:t,query:u,where:h,getDocs:b}=await v(async()=>{const{collection:s,query:r,where:d,getDocs:c}=await import("./index-CMVsiJL9.js").then(n=>n.aP);return{collection:s,query:r,where:d,getDocs:c}},__vite__mapDeps([0,1])),{db:y}=await v(async()=>{const{db:s}=await import("./index-CMVsiJL9.js").then(r=>r.aQ);return{db:s}},__vite__mapDeps([0,1])),a=t(y,"userProjects"),i=u(a,h("userId","==",o.id));(await b(i)).forEach(s=>{const r=s.data(),d=r.projectId,c=r.role;d&&c&&(!j[d]||j[d]!==c)&&(console.log(`Kullanıcının ${d} projesindeki rolü Firebase'den yüklendi: ${c}`),j[d]=c)})}catch(t){console.error("Firebase'den kullanıcı-proje rolleri yüklenirken hata:",t)}B.value=!0}function Q(){B.value=!1,f.value=null}async function re(){var o,l;if(f.value)try{if(U.value=!0,z.globalRole!==f.value.role){const t=z.globalRole;await S.updateUser(f.value.email,{role:t})}for(let t in j){const u=j[t],h=(l=(o=f.value.projectRoles)==null?void 0:o.find(b=>b.projectId===t))==null?void 0:l.role;if(u!==h)if(u)console.log(`Kullanıcı ${f.value.id}, ${t} projesine ${u} rolüyle ekleniyor/güncelleniyor...`),await S.addUserToProject(f.value.id,t,u);else{console.log(`Kullanıcı ${f.value.id}, ${t} projesinden çıkarılıyor...`);try{await D.removeUserFromProject(f.value.id,t)}catch(b){console.error("Kullanıcı projeden çıkarılamadı:",b)}}}E.showMessage?E.showMessage("Roller başarıyla güncellendi","success"):alert("Roller başarıyla güncellendi"),Q(),await K()}catch(t){console.error("Roller güncellenirken hata:",t),E.showMessage?E.showMessage("Roller güncellenirken hata oluştu","error"):alert("Roller güncellenirken hata oluştu")}finally{U.value=!1}}function ne(){K()}return ge(async()=>{await te(),await ee(),await K()}),(o,l)=>(m(),g("div",null,[e("div",ke,[e("div",we,[e("div",Re,[l[1]||(l[1]=e("h5",{class:"font-semibold text-lg dark:text-white-light mr-2"},"Rol Yönetimi",-1)),M.value?(m(),g("span",Pe)):k("",!0)]),e("div",null,[e("button",{type:"button",class:"btn btn-outline-primary",onClick:ne},l[2]||(l[2]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"w-4 h-4 ltr:mr-2 rtl:ml-2"},[e("polyline",{points:"1 4 1 10 7 10"}),e("polyline",{points:"23 20 23 14 17 14"}),e("path",{d:"M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"})],-1),A(" Yenile ")]))])]),e("div",De,[l[9]||(l[9]=e("h6",{class:"text-lg font-bold mb-3"},"Kullanıcılar",-1)),e("div",Ee,[e("button",{type:"button",class:"btn btn-warning mb-5",onClick:le},[N.value?(m(),g("span",$e)):k("",!0),l[3]||(l[3]=A(" Firebase'de Eksik Rolleri Düzelt "))]),_.value?(m(),g("div",{key:0,class:he(["my-3 p-2 border rounded",{"border-success text-success":_.value.success,"border-danger text-danger":!_.value.success}])},[A(w(_.value.message)+" ",1),_.value.details?(m(),g("div",xe,[l[4]||(l[4]=e("strong",null,"Detaylar:",-1)),A(" "+w(_.value.details),1)])):k("",!0)],2)):k("",!0)]),V.value.length>0?(m(),g("div",Ie,[e("table",Ae,[l[6]||(l[6]=e("thead",null,[e("tr",null,[e("th",null,"Kullanıcı"),e("th",null,"E-posta"),e("th",null,"Mevcut Roller"),e("th",null,"İşlemler")])],-1)),e("tbody",null,[(m(!0),g(L,null,q(V.value,t=>(m(),g("tr",{key:t.id},[e("td",null,w(t.name),1),e("td",null,w(t.email),1),e("td",null,[e("div",Se,[t.role?(m(),g("span",Te,w(t.role),1)):k("",!0),t.projectRoles&&t.projectRoles.length>0?(m(!0),g(L,{key:1},q(t.projectRoles,u=>(m(),g("span",{key:u.projectId+u.role,class:"badge badge-outline-info"},w(u.projectName)+": "+w(u.role),1))),128)):k("",!0)])]),l[5]||(l[5]=A()),e("td",null,[X.value?(m(),g("button",{key:0,type:"button",class:"btn btn-sm btn-primary",onClick:u=>se(t)}," Rolleri Düzenle ",8,Ve)):k("",!0)])]))),128))])])])):M.value?(m(),g("div",ze,l[7]||(l[7]=[e("div",{class:"animate-spin border-4 border-primary border-l-transparent rounded-full w-10 h-10"},null,-1)]))):(m(),g("div",Fe,l[8]||(l[8]=[e("p",null,"Kullanıcı bulunamadı.",-1)])))])]),(m(),be(fe,{to:"body"},[B.value?(m(),g("div",Me,[e("div",Ue,[e("div",Ke,[e("h5",Ce,w(f.value?f.value.name+" Rol Düzenleme":"Roller"),1),e("button",{type:"button",class:"text-gray-400 hover:text-gray-800",onClick:Q},l[10]||(l[10]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"w-6 h-6"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)]))]),f.value?(m(),g("div",Oe,[e("div",Le,[l[12]||(l[12]=e("label",{class:"block text-sm font-medium mb-2",for:"globalRole"},"Global Rol",-1)),H(e("select",{id:"globalRole","onUpdate:modelValue":l[0]||(l[0]=t=>z.globalRole=t),class:"form-select"},l[11]||(l[11]=[e("option",{value:""},"Seçiniz...",-1),e("option",{value:"admin"},"Admin",-1),e("option",{value:"proje_admin"},"Proje Admin",-1),e("option",{value:"depo_sorumlusu"},"Depo Sorumlusu",-1),e("option",{value:"user"},"Kullanıcı",-1)]),512),[[ve,z.globalRole]])]),e("div",qe,[l[14]||(l[14]=e("h6",{class:"font-semibold mb-3"},"Proje Bazlı Roller",-1)),$.value.length>0?(m(),g("div",Be,[(m(!0),g(L,null,q($.value,t=>(m(),g("div",{class:"mb-3 border-b pb-3",key:t.id},[e("div",Ne,[e("span",Qe,w(t.name),1)]),e("div",Ye,[(m(!0),g(L,null,q(Z.value,u=>(m(),g("label",{class:"flex items-center",key:u.value},[H(e("input",{type:"radio",class:"form-radio",value:u.value,"onUpdate:modelValue":h=>j[t.id]=h,name:"project-role-"+t.id},null,8,Ge),[[W,j[t.id]]]),e("span",He,w(u.label),1)]))),128)),e("label",Je,[H(e("input",{type:"radio",class:"form-radio",value:"","onUpdate:modelValue":u=>j[t.id]=u,name:"project-role-"+t.id},null,8,We),[[W,j[t.id]]]),l[13]||(l[13]=e("span",{class:"text-sm ml-2"},"Yok",-1))])])]))),128))])):(m(),g("div",Xe," Proje bulunamadı. "))]),e("div",Ze,[e("button",{type:"button",class:"btn btn-outline-danger",onClick:Q},"İptal"),e("button",{type:"button",class:"btn btn-primary",onClick:re,disabled:U.value},[U.value?(m(),g("span",oo)):k("",!0),l[15]||(l[15]=A(" Rolleri Kaydet "))],8,eo)])])):k("",!0)])])):k("",!0)]))]))}});export{so as default};
